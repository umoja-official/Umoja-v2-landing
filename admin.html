<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>UMOJA V2 • Admin</title>
  <style>
    body{margin:0;font-family:system-ui;background:#07181a;color:#eaf6f5;padding:18px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:16px;margin-bottom:14px}
    h1{margin:0 0 10px}
    table{width:100%;border-collapse:collapse}
    td,th{padding:10px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left}
    .muted{color:rgba(234,246,245,.7)}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);color:#eaf6f5;cursor:pointer;font-weight:800}
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <p class="muted">Invitation activity (opens + registrations)</p>

  <div class="card" id="authBox">Checking admin access…</div>

  <div class="card" id="summary" style="display:none">
    <button class="btn" id="back">Back to site</button>
    <button class="btn" id="logout">Logout</button>
  </div>

  <div class="card" id="clicksCard" style="display:none">
    <h3>Latest Invite Opens</h3>
    <table>
      <thead><tr><th>Ref</th><th>Time</th><th>User Agent</th></tr></thead>
      <tbody id="clicksRows"></tbody>
    </table>
  </div>

  <div class="card" id="usersCard" style="display:none">
    <h3>Latest Registrations</h3>
    <table>
      <thead><tr><th>Email</th><th>Referred By</th><th>Created</th></tr></thead>
      <tbody id="usersRows"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = PASTE_YOUR_FIREBASE_CONFIG_HERE;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authBox = document.getElementById("authBox");
    const summary = document.getElementById("summary");
    const clicksCard = document.getElementById("clicksCard");
    const usersCard = document.getElementById("usersCard");

    document.getElementById("back").onclick = ()=> location.href = "index.html";
    document.getElementById("logout").onclick = ()=> signOut(auth);

    function tsToText(ts){
      if(!ts) return "";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        authBox.textContent = "❌ Not logged in. Please login on the main site first.";
        return;
      }

      const adminSnap = await getDoc(doc(db, "admins", user.uid));
      if(!adminSnap.exists()){
        authBox.textContent = "❌ Access denied. You are not an admin.";
        return;
      }

      authBox.textContent = "✅ Admin access granted.";
      summary.style.display = "";
      clicksCard.style.display = "";
      usersCard.style.display = "";

      // Load latest clicks
      const clicksQ = query(collection(db, "inviteClicks"), orderBy("createdAt", "desc"), limit(25));
      const clicksSnap = await getDocs(clicksQ);
      document.getElementById("clicksRows").innerHTML = clicksSnap.docs.map(d=>{
        const x = d.data();
        return `<tr><td>${x.ref || ""}</td><td>${tsToText(x.createdAt)}</td><td style="max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${(x.ua||"")}</td></tr>`;
      }).join("");

      // Load latest users
      const usersQ = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(25));
      const usersSnap = await getDocs(usersQ);
      document.getElementById("usersRows").innerHTML = usersSnap.docs.map(d=>{
        const x = d.data();
        return `<tr><td>${x.email || ""}</td><td>${x.referredBy || ""}</td><td>${tsToText(x.createdAt)}</td></tr>`;
      }).join("");
    });
  </script>
</body>
</html>

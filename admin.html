<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UMOJA â€¢ Admin Dashboard</title>
  <style>
    :root{
      --bg:#07181a; --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.12);
      --text:#eaf6f5; --muted:rgba(234,246,245,.72); --good:#38f2b3; --bad:#ff6b6b;
    }
    body{margin:0;background:radial-gradient(1200px 600px at 20% 0%, rgba(56,242,179,.12), transparent 60%), var(--bg);
      color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .brand img{width:38px;height:38px;border-radius:50%;object-fit:contain;background:rgba(255,255,255,.05);border:1px solid var(--stroke);}
    .pill{padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:rgba(255,255,255,.04);color:var(--muted);font-size:13px}
    .row{display:grid;grid-template-columns:1.3fr .7fr;gap:14px;}
    .card{border:1px solid var(--stroke);background:var(--card);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .h{font-weight:800;letter-spacing:.2px;margin:0 0 8px 0}
    .btn{cursor:pointer;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:700}
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.danger{border-color:rgba(255,107,107,.4)}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);color:var(--text);outline:none;}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{color:var(--muted);text-align:left;font-weight:800}
    .muted{color:var(--muted)}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted)}
    .ok{color:var(--good);font-weight:800}
    .no{color:var(--bad);font-weight:800}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <!-- put your logo file in the same folder -->
        <img src="umoja-logo.png" alt="UMOJA" />
        <div>
          <div style="font-weight:900">UMOJA Admin</div>
          <div class="muted" style="font-size:13px">Invitation tracking & management</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <div class="pill" id="who">Checking accessâ€¦</div>
        <button class="btn danger" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <h3 class="h">Invitation Clicks</h3>
          <div style="display:flex;gap:10px">
            <button class="btn" id="refreshBtn">Refresh</button>
            <button class="btn" id="exportBtn">Export CSV</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 14px">
          <div>
            <div class="muted" style="font-size:12px;margin:0 0 6px">Filter by ref code</div>
            <input id="filterRef" placeholder="e.g. ABC123" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;margin:0 0 6px">Filter by country (optional)</div>
            <input id="filterCountry" placeholder="e.g. US" />
          </div>
        </div>

        <div class="muted" id="status" style="margin-bottom:8px">â€”</div>

        <div style="overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.08)">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Ref</th>
                <th>Landing</th>
                <th>Country</th>
                <th>Signed In?</th>
                <th>User</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="6" class="muted">No data yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3 class="h">Admin Tools</h3>

        <div class="muted" style="font-size:13px;margin-bottom:10px">
          This page is protected by <b>Firebase Auth + Firestore Rules</b>. Non-admins cannot read admin data.
        </div>

        <div style="display:grid;gap:10px">
          <button class="btn" id="openMainBtn">Open Main Site</button>
          <div class="tag">Tip: keep this file name secret if you want, but rules are the real security.</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase (v10 modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ðŸ”¥ PASTE YOUR firebaseConfig HERE (same one as index.html)
    const firebaseConfig = {
      apiKey: "PASTE",
      authDomain: "PASTE",
      projectId: "PASTE",
      storageBucket: "PASTE",
      messagingSenderId: "PASTE",
      appId: "PASTE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const who = document.getElementById("who");
    const status = document.getElementById("status");
    const rows = document.getElementById("rows");
    const filterRef = document.getElementById("filterRef");
    const filterCountry = document.getElementById("filterCountry");

    const logoutBtn = document.getElementById("logoutBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const exportBtn = document.getElementById("exportBtn");
    const openMainBtn = document.getElementById("openMainBtn");

    let cached = [];

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtDate(ms){
      try { return new Date(ms).toLocaleString(); } catch { return "-"; }
    }

    function render(data){
      const ref = filterRef.value.trim().toUpperCase();
      const ctry = filterCountry.value.trim().toUpperCase();

      const filtered = data.filter(d => {
        const okRef = !ref || String(d.ref||"").toUpperCase().includes(ref);
        const okC = !ctry || String(d.country||"").toUpperCase().includes(ctry);
        return okRef && okC;
      });

      status.textContent = `Showing ${filtered.length} / ${data.length} records`;

      if (!filtered.length){
        rows.innerHTML = `<tr><td colspan="6" class="muted">No matching records.</td></tr>`;
        return;
      }

      rows.innerHTML = filtered.map(d => `
        <tr>
          <td>${esc(fmtDate(d.createdAt))}</td>
          <td><span class="tag">${esc(d.ref || "-")}</span></td>
          <td class="muted">${esc(d.landing || "-")}</td>
          <td class="muted">${esc(d.country || "-")}</td>
          <td>${d.signedIn ? `<span class="ok">YES</span>` : `<span class="no">NO</span>`}</td>
          <td class="muted">${esc(d.uid || "-")}</td>
        </tr>
      `).join("");
    }

    async function loadClicks(){
      status.textContent = "Loadingâ€¦";
      rows.innerHTML = `<tr><td colspan="6" class="muted">Loadingâ€¦</td></tr>`;

      // Admin-only read (rules will block non-admin)
      const qy = query(collection(db, "invitationClicks"), orderBy("createdAt", "desc"), limit(200));
      const snap = await getDocs(qy);

      cached = snap.docs.map(doc => {
        const x = doc.data();
        return {
          id: doc.id,
          createdAt: x.createdAt || 0,
          ref: x.ref || "",
          landing: x.landing || "",
          country: x.country || "",
          signedIn: !!x.signedIn,
          uid: x.uid || ""
        };
      });

      render(cached);
    }

    function downloadCSV(){
      const ref = filterRef.value.trim().toUpperCase();
      const ctry = filterCountry.value.trim().toUpperCase();
      const filtered = cached.filter(d => {
        const okRef = !ref || String(d.ref||"").toUpperCase().includes(ref);
        const okC = !ctry || String(d.country||"").toUpperCase().includes(ctry);
        return okRef && okC;
      });

      const header = ["time","ref","landing","country","signedIn","uid"];
      const lines = [header.join(",")].concat(
        filtered.map(d => [
          `"${new Date(d.createdAt).toISOString()}"`,
          `"${String(d.ref).replace(/"/g,'""')}"`,
          `"${String(d.landing).replace(/"/g,'""')}"`,
          `"${String(d.country).replace(/"/g,'""')}"`,
          `"${d.signedIn}"`,
          `"${String(d.uid).replace(/"/g,'""')}"`
        ].join(","))
      );

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "umoja_invitationClicks.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    filterRef.addEventListener("input", () => render(cached));
    filterCountry.addEventListener("input", () => render(cached));

    refreshBtn.addEventListener("click", async () => {
      try { await loadClicks(); }
      catch(e){ status.textContent = "Failed to load (not admin or rules blocking)."; console.error(e); }
    });

    exportBtn.addEventListener("click", downloadCSV);

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      location.href = "index.html";
    });

    openMainBtn.addEventListener("click", () => location.href = "index.html");

    // ðŸ” Guard: must be logged in AND have admin claim
    onAuthStateChanged(auth, async (user) => {
      if (!user){
        who.textContent = "Not signed in â†’ redirectingâ€¦";
        location.href = "index.html";
        return;
      }

      try{
        const token = await user.getIdTokenResult(true);
        const isAdmin = token?.claims?.admin === true;

        if (!isAdmin){
          who.textContent = "Access denied (not admin)";
          // Optional: redirect away
          setTimeout(() => location.href = "index.html", 800);
          return;
        }

        who.textContent = `Admin: ${user.email || user.uid}`;
        await loadClicks();

      }catch(e){
        who.textContent = "Access check failed";
        console.error(e);
        setTimeout(() => location.href = "index.html", 800);
      }
    });
  </script>
</body>
</html>

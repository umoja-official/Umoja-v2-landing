<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UMOJA V2 • Admin Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#061516;color:#eaf6f5;margin:0;padding:24px}
    .card{max-width:1100px;margin:0 auto;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:18px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .box{flex:1;min-width:320px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px}
    input,button{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#eaf6f5}
    button{cursor:pointer;background:rgba(0,255,180,.16)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left;vertical-align:top}
    .msg{margin-top:10px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12)}
  </style>
</head>
<body>
  <div class="card">
    <h1>UMOJA V2 — Admin Dashboard</h1>
    <p>URL: <b>/admin.html</b></p>

    <div class="row">
      <div class="box">
        <h3>Admin Login</h3>
        <input id="email" placeholder="Email or Phone" style="width:100%;margin-bottom:10px" />
        <input id="pass" placeholder="Password" type="password" style="width:100%;margin-bottom:10px" />
        <button id="loginBtn">Login</button>
        <button id="logoutBtn">Logout</button>
        <div id="msg" class="msg" style="display:none"></div>
      </div>

      <div class="box">
        <h3>Quick Stats</h3>
        <div id="stats">—</div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="box">
        <h3>Invite Clicks (latest 50)</h3>
        <div style="overflow:auto;max-height:360px">
          <table>
            <thead>
              <tr><th>Time</th><th>Ref</th><th>URL</th></tr>
            </thead>
            <tbody id="clicksTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="box">
        <h3>Users (latest 50)</h3>
        <div style="overflow:auto;max-height:360px">
          <table>
            <thead>
              <tr><th>Time</th><th>Email/Phone</th><th>Referred By</th><th>My Ref</th></tr>
            </thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      orderBy,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ✅ REPLACE with SAME firebaseConfig you used in index.html (same web app / appId)
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const msg = (t, type="ok") => {
      const el = document.getElementById("msg");
      el.style.display = "block";
      el.textContent = t;
      el.style.borderColor = type==="err" ? "rgba(255,90,90,.6)" : "rgba(0,255,180,.5)";
    };

    function toAuthEmail(v) {
      v = (v||"").trim();
      if (!v) return "";
      if (v.includes("@")) return v.toLowerCase();
      const digits = v.replace(/[^\d+]/g, "");
      const safe = digits.replace(/\+/g, "plus");
      return `${safe}@umojav2.local`;
    }

    async function isAdmin(uid) {
      // Admin check: Firestore collection "admins", docId = uid, field role="admin"
      const snap = await getDoc(doc(db, "admins", uid));
      return snap.exists() && (snap.data()?.role === "admin");
    }

    async function loadTables() {
      // clicks
      const clicksQ = query(collection(db, "inviteClicks"), orderBy("createdAt", "desc"), limit(50));
      const clicksSnap = await getDocs(clicksQ);
      const clicksT = document.getElementById("clicksTbody");
      clicksT.innerHTML = "";
      clicksSnap.forEach(d => {
        const x = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${x.createdAt?.toDate?.()?.toLocaleString?.() || ""}</td>
                        <td>${x.ref || ""}</td>
                        <td style="max-width:420px;word-break:break-word">${x.url || ""}</td>`;
        clicksT.appendChild(tr);
      });

      // users
      const usersQ = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(50));
      const usersSnap = await getDocs(usersQ);
      const usersT = document.getElementById("usersTbody");
      usersT.innerHTML = "";
      usersSnap.forEach(d => {
        const x = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${x.createdAt?.toDate?.()?.toLocaleString?.() || ""}</td>
                        <td>${x.emailOrPhone || ""}</td>
                        <td>${x.referredBy || ""}</td>
                        <td>${x.myRefCode || ""}</td>`;
        usersT.appendChild(tr);
      });

      document.getElementById("stats").textContent =
        `Loaded ${clicksSnap.size} invite clicks & ${usersSnap.size} users.`;
    }

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const emailOrPhone = document.getElementById("email").value;
      const pass = document.getElementById("pass").value;
      try {
        await signInWithEmailAndPassword(auth, toAuthEmail(emailOrPhone), pass);
      } catch (e) {
        msg(e?.message || String(e), "err");
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      msg("Logged out.");
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) return msg("Please login as admin.");
      const ok = await isAdmin(user.uid);
      if (!ok) {
        msg("❌ Access denied. You are not an admin.", "err");
        await signOut(auth);
        return;
      }
      msg("✅ Admin verified. Loading dashboard...");
      await loadTables();
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UMOJA V2 • Register / Login</title>

  <style>
    :root{
      --bg:#07181a;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text:#eaf6f5;
      --muted: rgba(234,246,245,.70);
      --accent:#2bd3b1;
      --accent2:#0bbf9a;
      --danger:#ff5d5d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 50% 10%, rgba(43,211,177,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(0,0,0,.65), rgba(0,0,0,.9)),
        linear-gradient(180deg, #0a2a2c, #061618);
      color:var(--text);
      padding:24px;
    }
    .wrap{width:min(460px, 100%);}
    .brand{
      text-align:center;
      margin-bottom:16px;
    }
    .logo{
      width:74px;height:74px;border-radius:50%;
      margin:0 auto 10px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(43,211,177,.25), rgba(0,0,0,.55));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .brand h1{
      margin:0;
      font-size:32px;
      letter-spacing:2px;
    }
    .brand p{margin:6px 0 0; color:var(--muted)}
    .card{
      margin-top:14px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .tabs{
      display:flex;
      gap:10px;
      background: rgba(0,0,0,.18);
      padding:8px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
    }
    .tab{
      flex:1;
      padding:12px 10px;
      border-radius:14px;
      text-align:center;
      font-weight:700;
      cursor:pointer;
      color: rgba(234,246,245,.65);
      user-select:none;
    }
    .tab.active{
      background: rgba(43,211,177,.14);
      color: var(--text);
      border:1px solid rgba(43,211,177,.20);
    }
    .form{margin-top:14px;}
    .field{
      margin-top:12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
    }
    .field input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:18px;
      padding:8px 6px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      width:100%;
      margin-top:14px;
      border:none;
      border-radius:18px;
      padding:14px 14px;
      font-size:18px;
      font-weight:800;
      cursor:pointer;
      color:#06201e;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(43,211,177,.18);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .small{
      margin-top:10px;
      text-align:center;
      color: rgba(234,246,245,.70);
      font-size:14px;
      line-height:1.35;
    }
    .small a{color:var(--accent); text-decoration:none; font-weight:700}
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(234,246,245,.85);
      font-size:14px;
      display:none;
    }
    .msg.error{border-color: rgba(255,93,93,.35); color: #ffd6d6;}
    .inviteBox{
      margin-top:12px;
      border-radius:18px;
      padding:12px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      display:none;
    }
    .inviteBox .label{color:rgba(234,246,245,.65); font-size:13px}
    .inviteBox .code{
      margin-top:6px;
      font-size:20px;
      letter-spacing:2px;
      font-weight:800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo">
        <!-- Optional: put your logo image inside -->
        <!-- <img src="logo.png" alt="UMOJA" style="width:100%;height:100%;object-fit:cover;"> -->
      </div>
      <h1>UMOJA V2</h1>
      <p>Official Landing • Verify • Invest • Invite</p>
    </div>

    <div class="card">
      <div class="tabs">
        <div id="tabRegister" class="tab active">Register</div>
        <div id="tabLogin" class="tab">Login</div>
      </div>

      <!-- PANELS -->
<div id="registerPanel">
  <div class="form">
    <div class="field">
      <input id="emailOrPhone" type="text" placeholder="Email or Phone" autocomplete="username" />
    </div>

    <div class="field row">
      <input id="password" type="password" placeholder="Password" autocomplete="new-password" />
      <button id="togglePw" type="button">Show</button>
    </div>

    <button id="actionBtn" class="btn">Create Account</button>

    <div id="inviteBox" class="inviteBox" style="display:none;">
      <div class="muted">Referral detected from link:</div>
      <div id="refText" class="refText"></div>
    </div>

    <div class="smallMuted">
      By continuing you agree to the <a href="#" id="openAgreement">Registration Agreement</a>.
    </div>

    <div id="msg" class="msg"></div>
  </div>
</div>

<div id="loginPanel" style="display:none;">
  <div class="form">
    <div class="field">
      <input id="loginEmail" type="text" placeholder="Email or Phone" autocomplete="username" />
    </div>

    <div class="field row">
      <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="toggleLoginPw" type="button">Show</button>
    </div>

    <button id="loginBtn" class="btn">Login</button>

    <div class="smallMuted">
      By continuing you agree to the <a href="#" id="openAgreement2">Registration Agreement</a>.
    </div>

    <div id="loginMsg" class="msg"></div>
  </div>
</div>

<!-- LOGIN PANEL -->
<div id="loginPanel" style="display:none;">
  <div class="form">
    <div class="field">
      <input id="loginEmail" type="text" placeholder="Email" autocomplete="username" />
    </div>

    <div class="field row">
      <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="toggleLoginPw" type="button">Show</button>
    </div>

    <button id="loginBtn" class="btn">Login</button>
    <div id="loginMsg" class="msg"></div>
  </div>
</div>


        <div class="field row">
          <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
          <button id="togglePw" type="button" style="border:none;background:rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:700;">Show</button>
        </div>

        <button id="actionBtn" class="btn">Create Account</button>

        <div id="inviteBox" class="inviteBox">
          <div class="label">Referral detected from link:</div>
          <div id="inviteCode" class="code"></div>
        </div>

        <div id="msg" class="msg"></div>

        <div class="small">
          By continuing you agree to the <a href="#" onclick="alert('Add your Registration Agreement page/link here');return false;">Registration Agreement</a>.
        </div>
      </div>
    </div>
  </div>
<!-- LOGGED IN VIEW -->
<section id="loggedInPage" style="display:none; margin-top:16px;">
  <div class="card">
    <h2 style="margin:0 0 10px 0;">Welcome ✅</h2>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="goVerify">Verify</button>
      <button class="btn" id="goInvest">Invest</button>
      <button class="btn" id="goInvite">Invite</button>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </div>
</section>

  <script type="module">
  // =====================================================
  //  UMOJA V2 - Main Site (Register/Login + Invitation)
  //  IMPORTANT:
  //  1) Remove ALL firebase-*-compat scripts if present.
  //  2) Keep ONLY this module script.
  //  3) Replace firebaseConfig with the config from the
  //     web app whose appId matches your project (b4bb...).
  // =====================================================

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    addDoc,
    collection,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ✅ REPLACE THESE VALUES with Firebase Console -> Project settings -> Your apps -> (choose correct web app) -> Config
  const firebaseConfig = {
    apiKey: "REPLACE_ME",
    authDomain: "REPLACE_ME",
    projectId: "REPLACE_ME",
    storageBucket: "REPLACE_ME",
    messagingSenderId: "REPLACE_ME",
    appId: "REPLACE_ME"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // -------------------------
  // Helpers
  // -------------------------
  function qs(id) { return document.getElementById(id); }

  function isPhoneLike(v) {
    const s = (v || "").trim();
    return /^[+]?[\d\s().-]{7,}$/.test(s) && /[0-9]/.test(s);
  }

  // We support "Email or Phone" WITHOUT SMS by turning phone into a safe pseudo-email
  function toAuthEmail(emailOrPhoneRaw) {
    const v = (emailOrPhoneRaw || "").trim();
    if (!v) return "";
    if (v.includes("@")) return v.toLowerCase();
    // phone -> normalize digits -> pseudo email
    const digits = v.replace(/[^\d+]/g, "");
    const safe = digits.replace(/\+/g, "plus");
    return `${safe}@umojav2.local`;
  }

  function getRefFromUrl() {
    const p = new URLSearchParams(window.location.search);
    return (p.get("ref") || "").trim();
  }

  function randomRefCode(len = 8) {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
    return out;
  }

  async function ensureMyRefCode(uid) {
    const userRef = doc(db, "users", uid);
    const snap = await getDoc(userRef);
    if (snap.exists() && snap.data()?.myRefCode) return snap.data().myRefCode;

    // generate + save
    const myRefCode = randomRefCode(8);
    await setDoc(userRef, { myRefCode, updatedAt: serverTimestamp() }, { merge: true });
    return myRefCode;
  }

  // -------------------------
  // Invitation click logging (auto every open with ?ref=)
  // -------------------------
  async function logInviteOpenIfAny() {
    const ref = getRefFromUrl();
    if (!ref) return;

    // OPTIONAL: show "Referral detected" UI if you have these IDs
    const refBox = qs("refDetectedBox");
    const refValue = qs("refDetectedValue");
    if (refBox && refValue) {
      refBox.style.display = "block";
      refValue.textContent = ref;
    }

    // Log every open/click
    try {
      await addDoc(collection(db, "inviteClicks"), {
        ref,
        page: "index",
        userAgent: navigator.userAgent || null,
        url: window.location.href,
        createdAt: serverTimestamp()
      });
    } catch (e) {
      // don’t break UI
      console.warn("invite click log failed:", e);
    }
  }

  // -------------------------
  // UI bindings (IDs must exist in your HTML)
  // -------------------------
  // Expected IDs:
  // Tabs: registerTabBtn, loginTabBtn
  // Panels: registerPanel, loginPanel
  // Register: regEmailPhone, regPassword, regBtn
  // Login: loginEmailPhone, loginPassword, loginBtn
  // Optional: logoutBtn, statusMsg, inviteLinkOut, copyInviteBtn
  // Optional referral box: refDetectedBox, refDetectedValue

  function showMsg(msg, type = "ok") {
    const el = qs("statusMsg");
    if (!el) return;
    el.textContent = msg;
    el.style.display = "block";
    el.style.borderColor = type === "err" ? "rgba(255,90,90,.6)" : "rgba(0,255,180,.5)";
  }

  function setTab(which) {
    const regTab = qs("registerTabBtn");
    const logTab = qs("loginTabBtn");
    const regPanel = qs("registerPanel");
    const logPanel = qs("loginPanel");

    if (regTab && logTab) {
      regTab.classList.toggle("active", which === "register");
      logTab.classList.toggle("active", which === "login");
    }
    if (regPanel && logPanel) {
      regPanel.style.display = which === "register" ? "block" : "none";
      logPanel.style.display = which === "login" ? "block" : "none";
    }
  }

  // Hook tabs if present
  if (qs("registerTabBtn")) qs("registerTabBtn").addEventListener("click", () => setTab("register"));
  if (qs("loginTabBtn")) qs("loginTabBtn").addEventListener("click", () => setTab("login"));

  // Register
  if (qs("regBtn")) {
    qs("regBtn").addEventListener("click", async (e) => {
      e.preventDefault();

      const emailOrPhone = qs("regEmailPhone")?.value || "";
      const password = qs("regPassword")?.value || "";
      if (!emailOrPhone.trim() || password.length < 6) {
        showMsg("Enter Email/Phone and a password (6+ chars).", "err");
        return;
      }

      const authEmail = toAuthEmail(emailOrPhone);
      const ref = getRefFromUrl() || null;

      try {
        const cred = await createUserWithEmailAndPassword(auth, authEmail, password);

        // Save user profile + attach referral
        await setDoc(doc(db, "users", cred.user.uid), {
          emailOrPhone: emailOrPhone.trim(),
          authEmail,
          referredBy: ref,
          createdAt: serverTimestamp()
        }, { merge: true });

        const myRefCode = await ensureMyRefCode(cred.user.uid);

        const inviteOut = qs("inviteLinkOut");
        if (inviteOut) inviteOut.textContent = `${location.origin}${location.pathname}?ref=${myRefCode}`;

        showMsg("✅ Account created successfully.", "ok");
        setTab("login"); // or stay on register if you prefer
      } catch (err) {
        showMsg(err?.message || String(err), "err");
      }
    });
  }

  // Login
  if (qs("loginBtn")) {
    qs("loginBtn").addEventListener("click", async (e) => {
      e.preventDefault();

      const emailOrPhone = qs("loginEmailPhone")?.value || "";
      const password = qs("loginPassword")?.value || "";
      if (!emailOrPhone.trim() || !password) {
        showMsg("Enter Email/Phone and password.", "err");
        return;
      }

      const authEmail = toAuthEmail(emailOrPhone);

      try {
        await signInWithEmailAndPassword(auth, authEmail, password);

        // show invite link after login
        const uid = auth.currentUser?.uid;
        if (uid) {
          const myRefCode = await ensureMyRefCode(uid);
          const inviteOut = qs("inviteLinkOut");
          if (inviteOut) inviteOut.textContent = `${location.origin}${location.pathname}?ref=${myRefCode}`;
        }

        showMsg("✅ Logged in.", "ok");
      } catch (err) {
        showMsg(err?.message || String(err), "err");
      }
    });
  }

  // Logout (optional)
  if (qs("logoutBtn")) {
    qs("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      showMsg("Logged out.", "ok");
    });
  }

  // Copy invite (optional)
  if (qs("copyInviteBtn")) {
    qs("copyInviteBtn").addEventListener("click", async () => {
      const txt = qs("inviteLinkOut")?.textContent?.trim();
      if (!txt) return showMsg("No invite link yet.", "err");
      await navigator.clipboard.writeText(txt);
      showMsg("✅ Invite link copied.", "ok");
    });
  }

  // Auth state (optional UI updates)
  onAuthStateChanged(auth, async (user) => {
    // You can add UI changes here if you want
    // Example: show invite link when logged in
    if (user) {
      try {
        const myRefCode = await ensureMyRefCode(user.uid);
        const inviteOut = qs("inviteLinkOut");
        if (inviteOut) inviteOut.textContent = `${location.origin}${location.pathname}?ref=${myRefCode}`;
      } catch {}
    }
  });

  // Log invitation open immediately
  logInviteOpenIfAny();
    <script>
  // Tab switching (fix Login tab not clickable / not working)
  const tabRegister = document.getElementById("tabRegister");
  const tabLogin = document.getElementById("tabLogin");
  const registerPanel = document.getElementById("registerPanel");
  const loginPanel = document.getElementById("loginPanel");

  function showRegister(){
    tabRegister.classList.add("active");
    tabLogin.classList.remove("active");
    registerPanel.style.display = "block";
    loginPanel.style.display = "none";
  }

  function showLogin(){
    tabLogin.classList.add("active");
    tabRegister.classList.remove("active");
    loginPanel.style.display = "block";
    registerPanel.style.display = "none";
  }

  tabRegister.addEventListener("click", showRegister);
  tabLogin.addEventListener("click", showLogin);
</script>

</script>
<script>
const tabRegister = document.getElementById("tabRegister");
const tabLogin = document.getElementById("tabLogin");
const registerPanel = document.getElementById("registerPanel");
const loginPanel = document.getElementById("loginPanel");

tabRegister.onclick = () => {
  tabRegister.classList.add("active");
  tabLogin.classList.remove("active");
  registerPanel.style.display = "block";
  loginPanel.style.display = "none";
};

tabLogin.onclick = () => {
  tabLogin.classList.add("active");
  tabRegister.classList.remove("active");
  registerPanel.style.display = "none";
  loginPanel.style.display = "block";
};
</script>

</body>
</html>

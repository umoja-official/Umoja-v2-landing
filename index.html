<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UMOJA V2 • Register / Login</title>

  <style>
    :root{
      --bg:#07181a;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text:#eaf6f5;
      --muted: rgba(234,246,245,.70);
      --accent:#2bd3b1;
      --accent2:#0bbf9a;
      --danger:#ff5d5d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 50% 10%, rgba(43,211,177,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(0,0,0,.65), rgba(0,0,0,.9)),
        linear-gradient(180deg, #0a2a2c, #061618);
      color:var(--text);
      padding:24px;
    }
    .wrap{width:min(460px, 100%);}
    .brand{
      text-align:center;
      margin-bottom:16px;
    }
    .logo{
      width:74px;height:74px;border-radius:50%;
      margin:0 auto 10px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(43,211,177,.25), rgba(0,0,0,.55));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .brand h1{
      margin:0;
      font-size:32px;
      letter-spacing:2px;
    }
    .brand p{margin:6px 0 0; color:var(--muted)}
    .card{
      margin-top:14px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .tabs{
      display:flex;
      gap:10px;
      background: rgba(0,0,0,.18);
      padding:8px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
    }
    .tab{
      flex:1;
      padding:12px 10px;
      border-radius:14px;
      text-align:center;
      font-weight:700;
      cursor:pointer;
      color: rgba(234,246,245,.65);
      user-select:none;
    }
    .tab.active{
      background: rgba(43,211,177,.14);
      color: var(--text);
      border:1px solid rgba(43,211,177,.20);
    }
    .form{margin-top:14px;}
    .field{
      margin-top:12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
    }
    .field input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:18px;
      padding:8px 6px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      width:100%;
      margin-top:14px;
      border:none;
      border-radius:18px;
      padding:14px 14px;
      font-size:18px;
      font-weight:800;
      cursor:pointer;
      color:#06201e;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(43,211,177,.18);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .small{
      margin-top:10px;
      text-align:center;
      color: rgba(234,246,245,.70);
      font-size:14px;
      line-height:1.35;
    }
    .small a{color:var(--accent); text-decoration:none; font-weight:700}
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(234,246,245,.85);
      font-size:14px;
      display:none;
    }
    .msg.error{border-color: rgba(255,93,93,.35); color: #ffd6d6;}
    .inviteBox{
      margin-top:12px;
      border-radius:18px;
      padding:12px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      display:none;
    }
    .inviteBox .label{color:rgba(234,246,245,.65); font-size:13px}
    .inviteBox .code{
      margin-top:6px;
      font-size:20px;
      letter-spacing:2px;
      font-weight:800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo">
        <!-- Optional: put your logo image inside -->
        <!-- <img src="logo.png" alt="UMOJA" style="width:100%;height:100%;object-fit:cover;"> -->
      </div>
      <h1>UMOJA V2</h1>
      <p>Official Landing • Verify • Invest • Invite</p>
    </div>

    <div class="card">
      <div class="tabs">
        <div id="tabRegister" class="tab active">Register</div>
        <div id="tabLogin" class="tab">Login</div>
      </div>

      <div class="form">
        <div class="field">
          <input id="emailOrPhone" type="text" placeholder="Email or Phone" autocomplete="username" />
        </div>

        <div class="field row">
          <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
          <button id="togglePw" type="button" style="border:none;background:rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:700;">Show</button>
        </div>

        <button id="actionBtn" class="btn">Create Account</button>

        <div id="inviteBox" class="inviteBox">
          <div class="label">Referral detected from link:</div>
          <div id="inviteCode" class="code"></div>
        </div>

        <div id="msg" class="msg"></div>

        <div class="small">
          By continuing you agree to the <a href="#" onclick="alert('Add your Registration Agreement page/link here');return false;">Registration Agreement</a>.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // =========================
    // 1) Firebase (MODULAR SDK)
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      addDoc,
      collection,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // IMPORTANT: Use the config from the SAME Firebase project and SAME Web App (appId b4bb...)
    const firebaseConfig = {
  apiKey: "AIzaSyCbQ9fNYrq_qko-GUhKi3xSMkb_IKhrBB0",
  authDomain: "umoja-v2-landing.firebaseapp.com",
  projectId: "umoja-v2-landing",
  storageBucket: "umoja-v2-landing.firebasestorage.app",
  messagingSenderId: "964715983746",
  appId: "1:964715983746:web:b4bb1615f35d773ae7159b"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // 2) UI + Helpers
    // =========================
    const tabRegister = document.getElementById("tabRegister");
    const tabLogin = document.getElementById("tabLogin");
    const actionBtn = document.getElementById("actionBtn");
    const emailOrPhoneEl = document.getElementById("emailOrPhone");
    const passwordEl = document.getElementById("password");
    const togglePw = document.getElementById("togglePw");
    const msgEl = document.getElementById("msg");
    const inviteBox = document.getElementById("inviteBox");
    const inviteCodeEl = document.getElementById("inviteCode");

    let mode = "register"; // or "login"

    function showMsg(text, type="info"){
      msgEl.style.display = "block";
      msgEl.textContent = text;
      msgEl.classList.toggle("error", type==="error");
    }
    function clearMsg(){
      msgEl.style.display = "none";
      msgEl.textContent = "";
      msgEl.classList.remove("error");
    }

    function setMode(next){
      mode = next;
      clearMsg();
      if(mode==="register"){
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        actionBtn.textContent = "Create Account";
        passwordEl.autocomplete = "new-password";
      } else {
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        actionBtn.textContent = "Login";
        passwordEl.autocomplete = "current-password";
      }
    }

    togglePw.addEventListener("click", ()=>{
      const isPw = passwordEl.type === "password";
      passwordEl.type = isPw ? "text" : "password";
      togglePw.textContent = isPw ? "Hide" : "Show";
    });

    tabRegister.addEventListener("click", ()=>setMode("register"));
    tabLogin.addEventListener("click", ()=>setMode("login"));

    // Treat phone as "pseudo-email" so we can use email/password auth without SMS
    function normalizeLogin(input){
      const raw = (input || "").trim();
      if(!raw) return { email:"", display:"" };

      if(raw.includes("@")){
        return { email: raw.toLowerCase(), display: raw };
      }
      const digits = raw.replace(/[^\d+]/g,"");
      // pseudo email
      return { email: `${digits}@phone.umoja`, display: digits };
    }

    function getRefFromUrl(){
      const params = new URLSearchParams(window.location.search);
      return (params.get("ref") || "").trim();
    }

    function getStoredRef(){
      return (localStorage.getItem("umoja_ref") || "").trim();
    }

    function rememberRef(ref){
      if(ref) localStorage.setItem("umoja_ref", ref);
    }

    // =========================
    // 3) Invitation tracking
    // =========================
    async function logInviteClick(ref){
      try{
        await addDoc(collection(db, "inviteClicks"), {
          ref: ref || null,
          page: window.location.pathname,
          fullUrl: window.location.href,
          userAgent: navigator.userAgent,
          createdAt: serverTimestamp()
        });
      }catch(e){
        // silent
        console.warn("inviteClicks log failed:", e?.message || e);
      }
    }

    // Show referral box + log click
    (async function initReferral(){
      const ref = getRefFromUrl();
      if(ref){
        rememberRef(ref);
        inviteBox.style.display = "block";
        inviteCodeEl.textContent = ref;
      } else {
        const stored = getStoredRef();
        if(stored){
          inviteBox.style.display = "block";
          inviteCodeEl.textContent = stored;
        }
      }
      // log every open
      await logInviteClick(getRefFromUrl() || getStoredRef() || "");
    })();

    // =========================
    // 4) Register / Login
    // =========================
    actionBtn.addEventListener("click", async ()=>{
      clearMsg();

      const loginRaw = emailOrPhoneEl.value;
      const pw = passwordEl.value;

      if(!loginRaw.trim()) return showMsg("Please enter email or phone.", "error");
      if(!pw || pw.length < 6) return showMsg("Password must be at least 6 characters.", "error");

      const { email, display } = normalizeLogin(loginRaw);
      actionBtn.disabled = true;

      try{
        if(mode==="register"){
          const cred = await createUserWithEmailAndPassword(auth, email, pw);

          // Attach referral to user
          const ref = getRefFromUrl() || getStoredRef() || null;
          await setDoc(doc(db, "users", cred.user.uid), {
            emailOrPhone: display,
            emailNormalized: email,
            referredBy: ref,
            createdAt: serverTimestamp()
          }, { merge:true });

          showMsg("✅ Account created successfully.");
        } else {
          await signInWithEmailAndPassword(auth, email, pw);
          showMsg("✅ Login successful.");
        }
      }catch(e){
        showMsg(`Firebase: ${e?.message || e}`, "error");
      } finally {
        actionBtn.disabled = false;
      }
    });

    // Optional: after login redirect or show next section
    onAuthStateChanged(auth, (user)=>{
      if(user){
        // Example: redirect to admin if you want
        // window.location.href = "dashboard.html";
      }
    });
  </script>
</body>
</html>
